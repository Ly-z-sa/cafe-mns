<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link.active, .sidebar-link:hover {
            background-color: #4f46e5;
            color: white;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.flex {
            display: flex;
        }
        /* Hide elements based on role */
        .admin-only { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">CafeManager</h2>
            <p class="text-center text-gray-500 mb-8">Please sign in to continue</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign In</button>
                 <p id="loginError" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen bg-gray-200">
        <div class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="px-8 py-6 border-b border-gray-700">
                <h2 class="text-2xl font-semibold">CafeManager</h2>
                 <p class="text-sm text-gray-400">A coffee a day, keeps you awake.</p>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="sidebar-link active flex items-center px-4 py-2 rounded-lg" data-target="dashboard">
                    <i class="fas fa-chart-line w-6"></i><span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-lg" data-target="take-order">
                    <i class="fas fa-cash-register w-6"></i><span>Take Order</span>
                </a>
                <a href="#" class="sidebar-link admin-only flex items-center px-4 py-2 rounded-lg" data-target="menu-management">
                    <i class="fas fa-book-open w-6"></i><span>Manage Menus</span>
                </a>
                <a href="#" class="sidebar-link admin-only flex items-center px-4 py-2 rounded-lg" data-target="stock-management">
                    <i class="fas fa-boxes-stacked w-6"></i><span>Manage Stock</span>
                </a>
                <a href="#" class="sidebar-link admin-only flex items-center px-4 py-2 rounded-lg" data-target="staff-management">
                    <i class="fas fa-users w-6"></i><span>Manage Staff</span>
                </a>
                 <a href="#" id="signOutBtn" class="sidebar-link flex items-center px-4 py-2 rounded-lg mt-auto mb-4">
                    <i class="fas fa-sign-out-alt w-6"></i><span>Sign Out</span>
                </a>
                <div class="px-4 py-2 mt-4 text-xs text-gray-400 border-t border-gray-700">
                     User Role: <span id="userRoleDisplay" class="font-mono font-bold"></span><br>
                     User ID: <span id="userIdDisplay" class="font-mono"></span>
                </div>
            </nav>
        </div>

        <main class="flex-1 p-6 lg:p-10 overflow-auto">
            <section id="dashboard" class="content-section active">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Daily Report</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-gray-500 text-sm font-medium">Total Revenue</h3>
                        <p id="totalRevenue" class="text-3xl font-bold text-indigo-600">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-gray-500 text-sm font-medium">Total Orders</h3>
                        <p id="totalOrders" class="text-3xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-gray-500 text-sm font-medium">Low Stock Items</h3>
                        <p id="lowStockItems" class="text-3xl font-bold text-red-500">0</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-gray-500 text-sm font-medium">Most Popular Item</h3>
                        <p id="popularItem" class="text-xl font-bold text-indigo-600">-</p>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Today's Orders</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-4 text-sm font-semibold text-gray-600">Time</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Items</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Total</th>
                                </tr>
                            </thead>
                            <tbody id="dailyOrdersTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="take-order" class="content-section">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Take Order</h1>
                <div class="flex flex-col lg:flex-row gap-6">
                    <div id="orderMenuGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 flex-1">
                    </div>
                    <div class="w-full lg:w-1/3">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold mb-4">Current Order</h2>
                            <div id="currentOrderList" class="space-y-2">
                            </div>
                            <div class="border-t mt-4 pt-4">
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Total:</span>
                                    <span id="orderTotal">$0.00</span>
                                </div>
                                <button id="placeOrderBtn" class="w-full bg-green-500 text-white py-2 rounded-lg mt-4 hover:bg-green-600 disabled:bg-gray-400">Place Order</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="menu-management" class="content-section admin-only">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Manage Menus</h1>
                    <button id="addMenuBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add Menu Item</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-4 text-sm font-semibold text-gray-600">Name</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Price</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Category</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menuTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="stock-management" class="content-section admin-only">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Manage Stock</h1>
                    <button id="addStockBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add Stock Item</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-4 text-sm font-semibold text-gray-600">Item Name</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Quantity</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Unit</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stockTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="staff-management" class="content-section admin-only">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Manage Staff</h1>
                    <button id="addStaffBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add Staff Member</button>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-4 text-sm font-semibold text-gray-600">Name</th>
                                     <th class="p-4 text-sm font-semibold text-gray-600">Email</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Role</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="menuModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="menuModalTitle" class="text-2xl font-bold mb-6">Add Menu Item</h2>
            <form id="menuForm">
                <input type="hidden" id="menuId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="menuName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="menuName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="menuPrice" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="menuPrice" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="menuCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="menuCategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Coffee, Pastry" required>
                </div>

                <hr class="my-6">

                <div>
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Recipe Ingredients</h3>
                    <div class="flex items-end gap-2 mb-4">
                        <div class="flex-1">
                            <label for="stockItemSelect" class="block text-sm font-medium text-gray-700">Stock Item</label>
                            <select id="stockItemSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                </select>
                        </div>
                        <div class="w-1/4">
                             <label for="ingredientQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                             <input type="number" id="ingredientQuantity" step="any" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0.2">
                        </div>
                        <button type="button" id="addIngredientBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Add</button>
                    </div>
                    <div id="recipeIngredientsList" class="space-y-2 p-2 border rounded-md bg-gray-50 min-h-[50px]">
                        </div>
                </div>

                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="closeMenuModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="stockModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="stockModalTitle" class="text-2xl font-bold mb-6">Add Stock Item</h2>
            <form id="stockForm">
                <input type="hidden" id="stockId">
                <div class="mb-4">
                    <label for="stockName" class="block text-sm font-medium text-gray-700">Item Name</label>
                    <input type="text" id="stockName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="stockQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="stockUnit" class="block text-sm font-medium text-gray-700">Unit</label>
                    <input type="text" id="stockUnit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., kg, liters, units" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="closeStockModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="staffModalTitle" class="text-2xl font-bold mb-6">Add Staff Member</h2>
            <form id="staffForm">
                <input type="hidden" id="staffId">
                 <div class="mb-4">
                    <label for="staffName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="staffName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="staffEmail" class="block text-sm font-medium text-gray-700">Email (for login)</label>
                    <input type="email" id="staffEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="user@example.com" required>
                </div>
                <div class="mb-6">
                    <label for="staffRole" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="staffRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <p class="text-sm text-gray-500 mb-4">Note: You must create the user with an email and password in the Firebase Authentication console first. Then, add their details here.</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="closeStaffModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save Member</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="alertModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="alertMessage" class="text-lg mb-6"></p>
            <button id="closeAlertModal" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, onSnapshot, setDoc, deleteDoc, query, where, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVaw0yRtPfq7qxgrUOZCDXpILv41cRTEA",
            authDomain: "cafe-mns.firebaseapp.com",
            projectId: "cafe-mns",
            storageBucket: "cafe-mns.firebasestorage.app",
            messagingSenderId: "437536032484",
            appId: "1:437536032484:web:976a992a310bc1aceccef1",
            measurementId: "G-7KJ2G3HFV7"
        };
        const appId = "1:437536032484:web:976a992a310bc1aceccef1";
        
        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Global State ---
        let userId = null;
        let userRole = null;
        let unsubscribeListeners = [];
        let currentOrder = [];
        let currentRecipe = []; // State for the recipe builder

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const signOutBtn = document.getElementById('signOutBtn');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const menuTable = document.getElementById('menuTable');
        const stockTable = document.getElementById('stockTable');
        const staffTable = document.getElementById('staffTable');
        const dailyOrdersTable = document.getElementById('dailyOrdersTable');
        const orderMenuGrid = document.getElementById('orderMenuGrid');
        const currentOrderList = document.getElementById('currentOrderList');
        const orderTotalEl = document.getElementById('orderTotal');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const totalRevenueEl = document.getElementById('totalRevenue');
        const totalOrdersEl = document.getElementById('totalOrders');
        const lowStockItemsEl = document.getElementById('lowStockItems');
        const popularItemEl = document.getElementById('popularItem');

        // --- Modal UI Elements ---
        const menuModal = document.getElementById('menuModal');
        const stockModal = document.getElementById('stockModal');
        const staffModal = document.getElementById('staffModal');
        const menuForm = document.getElementById('menuForm');
        const stockForm = document.getElementById('stockForm');
        const staffForm = document.getElementById('staffForm');

        // --- Recipe Builder UI Elements ---
        const addIngredientBtn = document.getElementById('addIngredientBtn');
        const stockItemSelect = document.getElementById('stockItemSelect');
        const ingredientQuantityInput = document.getElementById('ingredientQuantity');
        const recipeIngredientsList = document.getElementById('recipeIngredientsList');

        // --- Utility Functions ---
        const showAlert = (message) => {
            alertMessage.textContent = message;
            alertModal.classList.add('flex');
        };

        // --- Navigation ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (link.id === 'signOutBtn') return;
                const targetId = link.getAttribute('data-target');
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetId) section.classList.add('active');
                });
            });
        });

        // --- Modal Handling ---
        const setupModal = (modal, openBtnId, closeBtnId, form) => {
            const openBtn = document.getElementById(openBtnId);
            const closeBtn = document.getElementById(closeBtnId);
            if (openBtn) openBtn.addEventListener('click', () => {
                form.reset();
                const idField = form.querySelector('input[type="hidden"]');
                if (idField) idField.value = '';
                modal.classList.add('flex');
            });
            if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('flex'));
        };
        // Note: Menu modal is now handled by custom listeners, not this generic function.
        setupModal(stockModal, 'addStockBtn', 'closeStockModal', stockForm);
        setupModal(staffModal, 'addStaffBtn', 'closeStaffModal', staffForm);
        document.getElementById('closeAlertModal').addEventListener('click', () => alertModal.classList.remove('flex'));

        // --- Firestore Collections ---
        const getCollectionRef = (collectionName) => collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        const getDocRef = (collectionName, docId) => doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            if (user) {
                userId = user.uid;
                userRole = await fetchUserRole(userId);
                if(userRole) {
                    document.getElementById('userIdDisplay').textContent = userId;
                    document.getElementById('userRoleDisplay').textContent = userRole;
                    updateUIVisibility(userRole);
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'flex';
                    initializeAppFunctions();
                } else {
                    showAlert("Could not verify your user role. Please contact an admin.");
                    await signOut(auth);
                }
            } else {
                userId = null;
                userRole = null;
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                resetUI();
            }
        });
        
        async function fetchUserRole(uid) {
            try {
                const docSnap = await getDoc(getDocRef('users', uid));
                return docSnap.exists() ? docSnap.data().role : null;
            } catch (error) {
                console.error("Error fetching user role:", error);
                return null;
            }
        }
        
        function updateUIVisibility(role) {
            const adminLinks = document.querySelectorAll('.sidebar-link.admin-only');
            const adminSections = document.querySelectorAll('.content-section.admin-only');
            if (role === 'admin') {
                adminLinks.forEach(el => el.style.display = 'flex');
                adminSections.forEach(el => el.style.display = '');
            } else {
                adminLinks.forEach(el => el.style.display = 'none');
                adminSections.forEach(el => el.style.display = 'none');
            }
        }
        
        function resetUI() {
            menuTable.innerHTML = '';
            stockTable.innerHTML = '';
            staffTable.innerHTML = '';
            dailyOrdersTable.innerHTML = '';
            orderMenuGrid.innerHTML = '';
            totalRevenueEl.textContent = '$0.00';
            totalOrdersEl.textContent = '0';
            lowStockItemsEl.textContent = '0';
            popularItemEl.textContent = '-';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email.value, password.value);
            } catch (error) {
                loginError.textContent = "Invalid email or password.";
            }
        });
        
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- App Initialization ---
        function initializeAppFunctions() {
            if (!userRole || !userId) return;
            setupMenuListener();
            setupStockListener();
            setupOrderListener();
            renderOrderMenu();
            if(userRole === 'admin') {
                setupStaffListener();
            }
        }

        // --- Recipe Builder Logic ---
        async function populateStockDropdown() {
            stockItemSelect.innerHTML = '<option value="">Select an ingredient...</option>';
            const stockSnapshot = await getDocs(getCollectionRef('stock'));
            stockSnapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.unit})`;
                option.dataset.name = item.name;
                stockItemSelect.appendChild(option);
            });
        }

        function renderRecipeList() {
            recipeIngredientsList.innerHTML = '';
            if (currentRecipe.length === 0) {
                recipeIngredientsList.innerHTML = '<p class="text-gray-500 text-sm">No ingredients added yet.</p>';
                return;
            }
            currentRecipe.forEach((ingredient, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-white p-2 rounded';
                itemEl.innerHTML = `<span><span class="font-semibold">${ingredient.name}</span> - ${ingredient.quantity}</span><button type="button" class="text-red-500 hover:text-red-700 remove-ingredient-btn" data-index="${index}"><i class="fas fa-trash"></i></button>`;
                recipeIngredientsList.appendChild(itemEl);
            });
        }

        addIngredientBtn.addEventListener('click', () => {
            const stockId = stockItemSelect.value;
            const quantity = parseFloat(ingredientQuantityInput.value);
            const selectedOption = stockItemSelect.options[stockItemSelect.selectedIndex];
            if (!stockId || !quantity || quantity <= 0) {
                showAlert("Please select an ingredient and enter a valid quantity.");
                return;
            }
            if (currentRecipe.some(ing => ing.stockId === stockId)) {
                showAlert("This ingredient is already in the recipe.");
                return;
            }
            currentRecipe.push({ stockId, name: selectedOption.dataset.name, quantity });
            renderRecipeList();
            ingredientQuantityInput.value = '';
            stockItemSelect.selectedIndex = 0;
        });

        recipeIngredientsList.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-ingredient-btn');
            if (removeBtn) {
                currentRecipe.splice(parseInt(removeBtn.dataset.index, 10), 1);
                renderRecipeList();
            }
        });

        // --- Menu Management (with Recipe Builder Integration) ---
        function setupMenuListener() {
            const unsub = onSnapshot(getCollectionRef('menus'), (snapshot) => {
                menuTable.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `<td class="p-4">${item.name}</td><td class="p-4">$${item.price.toFixed(2)}</td><td class="p-4">${item.category}</td><td class="p-4 space-x-2 admin-only" style="display: ${userRole === 'admin' ? 'table-cell' : 'none'}"><button class="text-blue-500 hover:text-blue-700 edit-menu" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 delete-menu" data-id="${item.id}"><i class="fas fa-trash"></i></button></td>`;
                    menuTable.appendChild(row);
                });
                renderOrderMenu();
            });
            unsubscribeListeners.push(unsub);
        }

        document.getElementById('addMenuBtn').addEventListener('click', async () => {
            menuForm.reset();
            document.getElementById('menuId').value = '';
            document.getElementById('menuModalTitle').textContent = 'Add Menu Item';
            currentRecipe = [];
            await populateStockDropdown();
            renderRecipeList();
            menuModal.classList.add('flex');
        });
        document.getElementById('closeMenuModal').addEventListener('click', () => menuModal.classList.remove('flex'));

        menuForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('menuId').value;
            const data = {
                name: document.getElementById('menuName').value,
                price: parseFloat(document.getElementById('menuPrice').value),
                category: document.getElementById('menuCategory').value,
                recipe: currentRecipe
            };
            try {
                if (id) {
                    await setDoc(getDocRef('menus', id), data);
                } else {
                    await addDoc(getCollectionRef('menus'), data);
                }
                menuModal.classList.remove('flex');
            } catch (error) {
                showAlert("Failed to save menu item.");
            }
        });

        menuTable.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || userRole !== 'admin') return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-menu')) {
                if (confirm('Are you sure?')) await deleteDoc(getDocRef('menus', id));
            } else if (target.classList.contains('edit-menu')) {
                const itemDoc = await getDoc(getDocRef('menus', id));
                if (itemDoc.exists()) {
                    const item = itemDoc.data();
                    document.getElementById('menuId').value = id;
                    document.getElementById('menuName').value = item.name;
                    document.getElementById('menuPrice').value = item.price;
                    document.getElementById('menuCategory').value = item.category;
                    document.getElementById('menuModalTitle').textContent = 'Edit Menu Item';
                    currentRecipe = item.recipe || [];
                    await populateStockDropdown();
                    renderRecipeList();
                    menuModal.classList.add('flex');
                }
            }
        });

        // --- Stock Management ---
        function setupStockListener() {
            const unsub = onSnapshot(getCollectionRef('stock'), (snapshot) => {
                stockTable.innerHTML = '';
                let lowStockCount = 0;
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    if (item.quantity <= 10) lowStockCount++;
                    const row = document.createElement('tr');
                    row.className = `border-b hover:bg-gray-50 ${item.quantity <= 10 ? 'bg-red-100' : ''}`;
                    row.innerHTML = `<td class="p-4">${item.name}</td><td class="p-4 font-bold">${item.quantity}</td><td class="p-4">${item.unit}</td><td class="p-4 space-x-2 admin-only" style="display: ${userRole === 'admin' ? 'table-cell' : 'none'}"><button class="text-blue-500 hover:text-blue-700 edit-stock" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 delete-stock" data-id="${item.id}"><i class="fas fa-trash"></i></button></td>`;
                    stockTable.appendChild(row);
                });
                lowStockItemsEl.textContent = lowStockCount;
            });
            unsubscribeListeners.push(unsub);
        }
        
        stockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('stockId').value;
            const data = {
                name: document.getElementById('stockName').value,
                quantity: parseInt(document.getElementById('stockQuantity').value),
                unit: document.getElementById('stockUnit').value,
            };
            try {
                if (id) {
                    await setDoc(getDocRef('stock', id), data);
                } else {
                    await addDoc(getCollectionRef('stock'), data);
                }
                stockModal.classList.remove('flex');
            } catch (error) {
                showAlert("Failed to save stock item.");
            }
        });
        
        stockTable.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || userRole !== 'admin') return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-stock')) {
                if (confirm('Are you sure?')) await deleteDoc(getDocRef('stock', id));
            } else if (target.classList.contains('edit-stock')) {
                const itemDoc = await getDoc(getDocRef('stock', id));
                if (itemDoc.exists()) {
                    const item = itemDoc.data();
                    document.getElementById('stockId').value = id;
                    document.getElementById('stockName').value = item.name;
                    document.getElementById('stockQuantity').value = item.quantity;
                    document.getElementById('stockUnit').value = item.unit;
                    document.getElementById('stockModalTitle').textContent = 'Edit Stock Item';
                    stockModal.classList.add('flex');
                }
            }
        });

        // --- Staff Management ---
        function setupStaffListener() {
            if (userRole !== 'admin') return;
            const unsub = onSnapshot(getCollectionRef('users'), (snapshot) => {
                staffTable.innerHTML = '';
                snapshot.forEach(doc => {
                    const member = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `<td class="p-4">${member.name}</td><td class="p-4">${member.email}</td><td class="p-4 font-semibold">${member.role}</td><td class="p-4 space-x-2"><button class="text-blue-500 hover:text-blue-700 edit-staff" data-id="${member.id}"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 delete-staff" data-id="${member.id}"><i class="fas fa-trash"></i></button></td>`;
                    staffTable.appendChild(row);
                });
            });
            unsubscribeListeners.push(unsub);
        }
        
        staffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('staffId').value; 
            const data = { name: staffName.value, email: staffEmail.value, role: staffRole.value };
            if (!id) {
                showAlert("For new staff, use an edit button or manage UIDs in Firestore.");
                return;
            }
            try {
                await setDoc(getDocRef('users', id), data);
                staffModal.classList.remove('flex');
            } catch (error) {
                showAlert("Failed to save staff member.");
            }
        });
        
        staffTable.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || userRole !== 'admin') return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-staff')) {
                if (confirm('This only removes the role document. Continue?')) {
                     await deleteDoc(getDocRef('users', id));
                }
            } else if (target.classList.contains('edit-staff')) {
                 const itemDoc = await getDoc(getDocRef('users', id));
                if (itemDoc.exists()) {
                    const item = itemDoc.data();
                    staffId.value = id;
                    staffName.value = item.name;
                    staffEmail.value = item.email;
                    staffRole.value = item.role;
                    staffModalTitle.textContent = 'Edit Staff Member';
                    staffModal.classList.add('flex');
                }
            }
        });

        // --- Order Taking ---
        async function renderOrderMenu() {
            if (!userId) return;
            orderMenuGrid.innerHTML = 'Loading menu...';
            const menuSnapshot = await getDocs(getCollectionRef('menus'));
            orderMenuGrid.innerHTML = '';
            menuSnapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow';
                card.innerHTML = `<h4 class="font-bold">${item.name}</h4><p class="text-gray-600">$${item.price.toFixed(2)}</p>`;
                card.addEventListener('click', () => addToOrder(item));
                orderMenuGrid.appendChild(card);
            });
        }

        function addToOrder(item) {
            const existingItem = currentOrder.find(orderItem => orderItem.id === item.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentOrder.push({ ...item, quantity: 1 });
            }
            updateCurrentOrderDisplay();
        }

        function updateCurrentOrderDisplay() {
            currentOrderList.innerHTML = '';
            let total = 0;
            currentOrder.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center text-sm';
                itemEl.innerHTML = `<div><p class="font-semibold">${item.name}</p><p class="text-gray-500">$${item.price.toFixed(2)} x ${item.quantity}</p></div><button class="text-red-500 remove-order-item" data-index="${index}"><i class="fas fa-times-circle"></i></button>`;
                currentOrderList.appendChild(itemEl);
                total += item.price * item.quantity;
            });
            orderTotalEl.textContent = `$${total.toFixed(2)}`;
            placeOrderBtn.disabled = currentOrder.length === 0;
        }

        currentOrderList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-order-item')) {
                currentOrder.splice(e.target.closest('.remove-order-item').dataset.index, 1);
                updateCurrentOrderDisplay();
            }
        });

        // =======================================================================
        // CRITICAL FIX: RESTRUCTURED TRANSACTION LOGIC
        // =======================================================================
        placeOrderBtn.addEventListener('click', async () => {
            if (currentOrder.length === 0) return;

            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Placing Order...';

            try {
                await runTransaction(db, async (transaction) => {
                    // --- PHASE 1: ALL READS ---
                    // Get all menu item data to compile a list of required stock ingredients
                    const menuRefs = currentOrder.map(item => getDocRef('menus', item.id));
                    const menuSnaps = await Promise.all(menuRefs.map(ref => transaction.get(ref)));
                    
                    const requiredStock = new Map(); // Key: stockId, Value: { required: amount, name: 'Milk' }

                    for (let i = 0; i < currentOrder.length; i++) {
                        const orderItem = currentOrder[i];
                        const menuSnap = menuSnaps[i];
                        if (!menuSnap.exists() || !menuSnap.data().recipe) {
                            throw new Error(`Recipe not found for ${orderItem.name}.`);
                        }
                        
                        for (const ingredient of menuSnap.data().recipe) {
                            const deduction = ingredient.quantity * orderItem.quantity;
                            const existing = requiredStock.get(ingredient.stockId) || { required: 0, name: ingredient.name };
                            requiredStock.set(ingredient.stockId, {
                                required: existing.required + deduction,
                                name: existing.name
                            });
                        }
                    }

                    // Get all required stock item data
                    const stockRefs = Array.from(requiredStock.keys()).map(id => getDocRef('stock', id));
                    const stockSnaps = await Promise.all(stockRefs.map(ref => transaction.get(ref)));
                    const stockData = new Map();
                    stockSnaps.forEach(snap => {
                        if (snap.exists()) {
                            stockData.set(snap.id, { ref: snap.ref, currentQuantity: snap.data().quantity, name: snap.data().name });
                        }
                    });

                    // --- PHASE 2: VALIDATION (IN MEMORY) ---
                    for (const [stockId, req] of requiredStock.entries()) {
                        const stock = stockData.get(stockId);
                        if (!stock) {
                            throw new Error(`Stock item "${req.name}" (${stockId}) not found in database.`);
                        }
                        if (stock.currentQuantity < req.required) {
                            throw new Error(`Not enough stock for ${stock.name}. Required: ${req.required}, Available: ${stock.currentQuantity}.`);
                        }
                    }

                    // --- PHASE 3: ALL WRITES ---
                    // If all validations pass, perform all writes
                    for (const [stockId, req] of requiredStock.entries()) {
                        const stock = stockData.get(stockId);
                        const newQuantity = stock.currentQuantity - req.required;
                        transaction.update(stock.ref, { quantity: newQuantity });
                    }

                    const total = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    const orderData = {
                        items: currentOrder.map(item => ({ name: item.name, price: item.price, quantity: item.quantity })),
                        total,
                        timestamp: Timestamp.now()
                    };
                    const newOrderRef = doc(getCollectionRef('orders'));
                    transaction.set(newOrderRef, orderData);
                });

                // If transaction is successful
                showAlert('Order placed and stock updated successfully!');
                currentOrder = [];
                updateCurrentOrderDisplay();

            } catch (error) {
                console.error("Order failed during transaction:", error);
                showAlert(`Order failed: ${error.message}`);
            } finally {
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Place Order';
            }
        });
        
        // --- Dashboard / Daily Report ---
        function setupOrderListener() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startOfToday = Timestamp.fromDate(today);
            const q = query(getCollectionRef('orders'), where('timestamp', '>=', startOfToday));
            const unsub = onSnapshot(q, (snapshot) => {
                let totalRevenue = 0, totalOrders = 0;
                const itemCounts = {};
                dailyOrdersTable.innerHTML = '';
                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    totalOrders++;
                    totalRevenue += order.total;
                    order.items.forEach(item => { itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity; });
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `<td class="p-4">${order.timestamp.toDate().toLocaleTimeString()}</td><td class="p-4">${order.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</td><td class="p-4 font-semibold">$${order.total.toFixed(2)}</td>`;
                    dailyOrdersTable.insertBefore(row, dailyOrdersTable.firstChild);
                });
                totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                totalOrdersEl.textContent = totalOrders;
                const popular = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
                popularItemEl.textContent = popular.length > 0 ? popular[0][0] : '-';
            });
            unsubscribeListeners.push(unsub);
        }
    </script>
</body>
</html>